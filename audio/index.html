<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>tus-js-client Audio Upload</title>
    <script src="https://cdn.jsdelivr.net/npm/tus-js-client@latest/dist/tus.min.js"></script>
    <style>
      .progress {
        margin-top: 10px;
        height: 20px;
        background: #eee;
      }
      .bar {
        height: 100%;
        width: 0%;
        background: green;
        transition: width 0.3s;
      }
    </style>
  </head>
  <body>
    <h1>Audio Upload with tus-js-client</h1>

    <label for="user-id">User ID:</label>
    <input type="text" id="user-id" placeholder="Enter your ID" />

    <label for="endpoint">Endpoint:</label>
    <input type="text" id="endpoint" value="http://localhost:8080/files" />

    <div>
      <button id="start-record">Start</button>
      <button id="stop-record" disabled>Stop</button>
      <button id="merge-record">Merge</button>
    </div>

    <div class="progress"><div class="bar"></div></div>
    <p id="upload-link"></p>

    <script>
      const startBtn = document.getElementById("start-record");
      const stopBtn = document.getElementById("stop-record");
      const mergeBtn = document.getElementById("merge-record");
      const userIdInput = document.getElementById("user-id");
      const endpointInput = document.getElementById("endpoint");
      const progressBar = document.querySelector(".bar");
      const uploadLink = document.getElementById("upload-link");

      let mediaRecorder = null;
      let mediaStream = null;
      let upload = null;
      let uploadUrl = null;
      let currentOffset = 0;

      startBtn.onclick = async () => {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(mediaStream, { mimeType: "audio/webm; codecs=opus" });

        const userId = userIdInput.value || "anonymous";

        mediaRecorder.ondataavailable = async (e) => {
          if (e.data.size === 0) return;
          const chunk = new Blob([e.data], { type: "audio/webm" });

          if (!upload) {
            upload = new tus.Upload(chunk, {
              endpoint: endpointInput.value,
              metadata: {
                filename: `recording_${Date.now()}.webm`,
                counselSessionId: userId,
              },
              uploadSizeDeferred: true,
              onSuccess: () => {
                uploadUrl = upload.url;
                currentOffset = 0;
                uploadLink.innerHTML = `<a href="${uploadUrl}" target="_blank">${uploadUrl}</a>`;
                console.log("Upload session created:", uploadUrl);
              },
              onError: (err) => console.error("Upload error:", err),
              onProgress: (bytesUploaded, bytesTotal) => {
                const percent = ((bytesUploaded / bytesTotal) * 100).toFixed(2);
                progressBar.style.width = `${percent}%`;
              },
            });
            upload.start();
          } else {
            const xhr = new XMLHttpRequest();
            xhr.open("PATCH", upload.url, true);
            xhr.setRequestHeader("Tus-Resumable", "1.0.0");
            xhr.setRequestHeader("Upload-Offset", currentOffset);
            xhr.setRequestHeader("Content-Type", "application/offset+octet-stream");
            xhr.onload = () => {
              if (xhr.status === 204) {
                currentOffset = parseInt(xhr.getResponseHeader("Upload-Offset"), 10);
                const percent = ((currentOffset / (currentOffset + 1)) * 100).toFixed(2);
                progressBar.style.width = `${percent}%`;
              } else {
                console.error("PATCH failed with status", xhr.status);
              }
            };
            xhr.onerror = () => console.error("PATCH network error");
            xhr.send(chunk);
          }
        };

        mediaRecorder.start(1000); // record in 1s intervals
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };

      stopBtn.onclick = () => {
        mediaRecorder.stop();
        mediaStream.getTracks().forEach((track) => track.stop());
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };

      mergeBtn.onclick = async () => {
        const userId = userIdInput.value;
        const res = await fetch(`http://localhost:8080/files/merge?userId=${encodeURIComponent(userId)}`);
        const json = await res.json();
        if (res.ok) {
          alert("Merged file available at: " + json.url);
          uploadLink.innerHTML = `<a href="${json.url}" target="_blank">${json.url}</a>`;
        } else {
          alert("Merge failed: " + json.error);
        }
      };
    </script>
  </body>
</html>
